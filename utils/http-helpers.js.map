{"version":3,"sources":["/tools/utils/http-helpers.js"],"names":[],"mappings":"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","file":"tools/utils/http-helpers.js.map","sourcesContent":["///\n/// utility functions for dealing with urls and http\n///\n\nvar os = require('os');\nvar util = require('util');\n\nvar _ = require('underscore');\nvar Future = require('fibers/future');\n\nvar files = require('../fs/files.js');\nvar auth = require('../meteor-services/auth.js');\nvar config = require('../meteor-services/config.js');\nvar release = require('../packaging/release.js');\nvar Console = require('../console/console.js').Console;\n\n\n// Helper that tracks bytes written to a writable\nvar WritableWithProgress = function (writable, listener) {\n  var self = this;\n  self._inner = writable;\n  self._listener = listener;\n};\n\n_.extend(WritableWithProgress.prototype, {\n  write: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk.length, false);\n    return self._inner.write(chunk, encoding);\n  },\n\n  end: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk ? chunk.length : 0, true);\n    return self._inner.end(chunk, encoding);\n  },\n\n  _progress: function (n, done) {\n    var self = this;\n\n    var state = self._state;\n    state.current += n;\n    if (done) {\n      state.current.done = true;\n    }\n    self.progress.reportProgress(state);\n  },\n\n  on: function (name, callback) {\n    return this._inner.on(name, callback);\n  },\n\n  once: function () {\n    return this._inner.once(...arguments);\n  },\n\n  emit: function () {\n    return this._inner.emit(...arguments);\n  }\n});\n\n\n// Compose a User-Agent header.\nvar getUserAgent = function () {\n  var version;\n\n  if (release.current)\n    version = release.current.isCheckout() ? 'checkout' : release.current.name;\n  else\n    // This happens when we haven't finished starting up yet (say, the\n    // user passed --release 1.2.3 and we have to download 1.2.3\n    // before we can get going), or if we are using an installed copy\n    // of Meteor to 'meteor update'ing a project that was created by a\n    // checkout and doesn't have a version yet.\n    version = files.inCheckout() ? 'checkout' : files.getToolsVersion();\n\n  return util.format('Meteor/%s OS/%s (%s; %s; %s;)', version,\n                     os.platform(), os.type(), os.release(), os.arch());\n};\n\n\nvar httpHelpers = exports;\n_.extend(exports, {\n  getUserAgent: getUserAgent,\n\n  // A wrapper around request with the following improvements:\n  //\n  // - It will respect proxy environment variables if present\n  //   (HTTP_PROXY or HTTPS_PROXY as appropriate).\n  //\n  // - It will set a reasonable User-Agent header.\n  //\n  // - If you omit the callback it will run synchronously. The return\n  //   value will be an object with keys 'response' and 'body' (with\n  //   the same meaning as the arguments to request's normal\n  //   callback), or it will throw.\n  //\n  // - If Set-Cookie headers are present on the response, *and* you\n  //   are using a callback, it will parse the cookies and include\n  //   them as a setCookie attribute on the object passed to the\n  //   callback. setCookie is a simple map from cookie name to cookie\n  //   value. If you want expiration time and attributes you'll have\n  //   to parse it yourself. If there are multiple Set-Cookie headers\n  //   for the same cookie it is unspecified which one you'll get.\n  //\n  // - You can provide a 'bodyStream' option which is a stream that\n  //   will be used for the body of the request.\n  //\n  // - For authenticated MDG services, you can set the\n  //   'useSessionHeader' and/or 'useAuthHeader' options (to true) to\n  //   send X-Meteor-Session/X-Meteor-Auth headers using values from\n  //   the session file.\n  //\n  // - forceSSL is always set to true. Always. And followRedirect is\n  //   set to false since it doesn't understand origins (see comment\n  //   in implementation).\n  //\n  // NB: With useSessionHeader and useAuthHeader, this function will\n  // read *and possibly write to* the session file, so if you are\n  // writing auth code (in auth.js) and you call it, be sure to reread\n  // the session file afterwards.\n  request: function (urlOrOptions, callback) {\n    var options;\n    if (!_.isObject(urlOrOptions))\n      options = { url: urlOrOptions };\n    else\n      options = _.clone(urlOrOptions);\n\n    var bodyStream;\n    if (_.has(options, 'bodyStream')) {\n      bodyStream = options.bodyStream;\n      delete options.bodyStream;\n    }\n\n    // Body stream length for progress\n    var bodyStreamLength = 0;\n    if (_.has(options, 'bodyStream')) {\n      bodyStreamLength = options.bodyStreamLength;\n      delete options.bodyStreamLength;\n    } else {\n      // Guess the body stream length as 1MB\n      // Hopefully if it's much bigger the caller will set it\n      // If it is much small, we will pleasantly surprise the user!\n      if (bodyStream) {\n        bodyStreamLength = 1024 * 1024;\n      }\n    }\n\n    // Response length for progress\n    var responseLength = 128 * 1024;\n    if (_.has(options, 'responseLength')) {\n      responseLength = options.responseLength;\n      delete options.responseLength;\n    }\n\n    var progress = null;\n    if (_.has(options, 'progress')) {\n      progress = options.progress;\n      delete options.progress;\n\n      if (callback) {\n        throw new Error(\"Not safe to use progress with callback\");\n      }\n    }\n\n    options.headers = _.extend({\n      'User-Agent': getUserAgent()\n    }, options.headers || {});\n\n    // This should never, ever be false, or else why are you using SSL?\n    options.forceSSL = true;\n\n    // followRedirect is very dangerous because request does not\n    // appear to segregate cookies by origin, so any cookies (and\n    // apparently headers as well, eg X-Meteor-Auth) sent on the\n    // original request could get forwarded to an unexpected domain in\n    // a redirect. This is almost certainly not something you ever\n    // want.\n    options.followRedirect = false;\n\n    var useSessionHeader = options.useSessionHeader;\n    delete options.useSessionHeader;\n    var useAuthHeader = options.useAuthHeader;\n    delete options.useAuthHeader;\n    if (useSessionHeader || useAuthHeader) {\n      var sessionHeader = auth.getSessionId(config.getAccountsDomain());\n      if (sessionHeader)\n        options.headers['X-Meteor-Session'] = sessionHeader;\n      if (callback)\n        throw new Error(\"session header can't be used with callback\");\n    }\n    if (useAuthHeader) {\n      var authHeader = auth.getSessionToken(config.getAccountsDomain());\n      if (authHeader)\n        options.headers['X-Meteor-Auth'] = authHeader;\n    }\n\n    var fut;\n    if (! callback) {\n      fut = new Future();\n      callback = function (err, response, body) {\n        if (err) {\n          fut['throw'](err);\n          return;\n        }\n\n        var setCookie = {};\n        _.each(response.headers[\"set-cookie\"] || [], function (h) {\n          var match = h.match(/^([^=\\s]+)=([^;\\s]+)/);\n          if (match)\n            setCookie[match[1]] = match[2];\n        });\n\n        if (useSessionHeader && _.has(response.headers, \"x-meteor-session\")) {\n          auth.setSessionId(config.getAccountsDomain(),\n                            response.headers['x-meteor-session']);\n        }\n\n        fut['return']({\n          response: response,\n          body: body,\n          setCookie: setCookie\n        });\n      };\n    }\n\n    // try to get proxy from environment.\n    // similar code is in packages/ddp/stream_client_nodejs.js\n    var proxy = process.env.HTTP_PROXY || process.env.http_proxy || null;\n    // if we're going to an https url, try the https_proxy env variable first.\n    if (/^https/i.test(options.url)) {\n      proxy = process.env.HTTPS_PROXY || process.env.https_proxy || proxy;\n    }\n    if (proxy && !options.proxy) {\n      options.proxy = proxy;\n    }\n\n    // request is the most heavy-weight of the tool's npm dependencies; don't\n    // require it until we definitely need it.\n    Console.debug(\"Doing HTTP request: \", options.method || 'GET', options.url);\n    var request = require('request');\n    var req = request(options, callback);\n\n\n    var totalProgress = { current: 0, end: bodyStreamLength + responseLength, done: false };\n\n    if (bodyStream) {\n      var dest = req;\n      if (progress) {\n        dest = new WritableWithProgress(dest, function (n, done) {\n          if (!totalProgress.done) {\n            totalProgress.current += n;\n            progress.reportProgress(totalProgress);\n          }\n        });\n      }\n      bodyStream.pipe(dest);\n    }\n\n    if (progress) {\n      httpHelpers._addProgressEvents(req);\n      req.on('progress', function (state) {\n        if (!totalProgress.done) {\n          totalProgress.current = bodyStreamLength + state.current;\n          totalProgress.end = bodyStreamLength + state.end;\n          totalProgress.done = state.done;\n\n          progress.reportProgress(totalProgress);\n        }\n      });\n    }\n\n    if (fut) {\n      try {\n        return fut.wait();\n      } finally {\n        if (progress) {\n          progress.reportProgressDone();\n        }\n      }\n    } else {\n      return req;\n    }\n  },\n\n  // Adds progress callbacks to a request\n  // Based on request-progress\n  _addProgressEvents: function (request) {\n    var state;\n\n    var emitProgress = function () {\n      request.emit('progress', state);\n    };\n\n    request\n      .on('response', function (response) {\n        state = {};\n        state.end = undefined;\n        state.done = false;\n        state.current = 0;\n        var contentLength = response.headers['content-length'];\n        if (contentLength) {\n          state.end = Number(contentLength);\n        }\n        emitProgress();\n      })\n      .on('data', function (data) {\n        state.current += data.length;\n        emitProgress();\n      })\n      .on('end', function (data) {\n        state.done = true;\n        emitProgress();\n      });\n  },\n\n  // A synchronous wrapper around request(...) that returns the response \"body\"\n  // or throws.\n  //\n  // (This has gone through a few refactors and it might be possible\n  // to fully roll it into httpHelpers.request() at this point.)\n  getUrl: function (urlOrOptions) {\n    try {\n      var result = httpHelpers.request(urlOrOptions);\n    } catch (e) {\n      throw new files.OfflineError(e);\n    }\n\n    const response = result.response;\n    const body = result.body;\n    const href = response.request.href;\n\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      throw Error(\n        body ||\n          `Could not get ${href}; server returned [${response.statusCode}]`);\n    } else {\n      return body;\n    }\n  }\n\n});\n"]}