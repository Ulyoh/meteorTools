{"version":3,"sources":["/tools/utils/fiber-helpers.js"],"names":[],"mappings":"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","file":"tools/utils/fiber-helpers.js.map","sourcesContent":["var _ = require(\"underscore\");\nvar Fiber = require(\"fibers\");\nvar Future = require(\"fibers/future\");\n\nexports.parallelEach = function (collection, callback, context) {\n  var futures = _.map(collection, function (...args) {\n    return function () {\n      return callback.apply(context, args);\n    }.future()();\n  });\n  Future.wait(futures);\n  // Throw if any threw.\n  _.each(futures, function (f) { f.get(); });\n};\n\nexports.firstTimeResolver = function (fut) {\n  var resolver = fut.resolver();\n  return function (err, val) {\n    if (fut.isResolved())\n      return;\n    resolver(err, val);\n  };\n};\n\n// Waits for one future given as an argument to be resolved. Throws if it threw,\n// otherwise returns whichever one returns first.  (Because of this, you\n// probably want at most one of the futures to be capable of returning, and have\n// the other be throw-only.)\nexports.waitForOne = function (...futures) {\n  var fiber = Fiber.current;\n  if (!fiber)\n    throw Error(\"Can't waitForOne without a fiber\");\n  if (futures.length === 0)\n    throw Error(\"Must wait for at least one future\");\n\n  var combinedFuture = new Future;\n  for (var i = 0; i < futures.length; ++i) {\n    var f = futures[i];\n    if (f.isResolved()) {\n      // Move its value into combinedFuture.\n      f.resolve(combinedFuture.resolver());\n      break;\n    }\n    // Otherwise, this function will be invoked when the future is resolved.\n    f.resolve(function (err, result) {\n      if (!combinedFuture.isResolved()) {\n        combinedFuture.resolver()(err, result);\n      }\n    });\n  }\n\n  return combinedFuture.wait();\n};\n\nfunction disallowedYield() {\n  throw new Error(\"Can't call yield in a noYieldsAllowed block!\");\n}\n// Allow testing Fiber.yield.disallowed.\ndisallowedYield.disallowed = true;\n\nexports.noYieldsAllowed = function (f, context) {\n  var savedYield = Fiber.yield;\n  Fiber.yield = disallowedYield;\n  try {\n    return f.call(context || null);\n  } finally {\n    Fiber.yield = savedYield;\n  }\n};\n\n// Borrowed from packages/meteor/dynamics_nodejs.js\n// Used by buildmessage\n\nexports.nodeCodeMustBeInFiber = function () {\n  if (!Fiber.current) {\n    throw new Error(\"Meteor code must always run within a Fiber. \" +\n                    \"Try wrapping callbacks that you pass to non-Meteor \" +\n                    \"libraries with Meteor.bindEnvironment.\");\n  }\n};\n\nvar nextSlot = 0;\nexports.EnvironmentVariable = function (defaultValue) {\n  var self = this;\n  self.slot = 'slot' + nextSlot++;\n  self.defaultValue = defaultValue;\n};\n\n_.extend(exports.EnvironmentVariable.prototype, {\n  get: function () {\n    var self = this;\n    exports.nodeCodeMustBeInFiber();\n\n    if (!Fiber.current._meteorDynamics)\n      return self.defaultValue;\n    if (!_.has(Fiber.current._meteorDynamics, self.slot))\n      return self.defaultValue;\n    return Fiber.current._meteorDynamics[self.slot];\n  },\n\n  withValue: function (value, func) {\n    var self = this;\n    exports.nodeCodeMustBeInFiber();\n\n    if (!Fiber.current._meteorDynamics)\n      Fiber.current._meteorDynamics = {};\n    var currentValues = Fiber.current._meteorDynamics;\n\n    var saved = _.has(currentValues, self.slot)\n          ? currentValues[self.slot] : self.defaultValue;\n    currentValues[self.slot] = value;\n\n    try {\n      return func();\n    } finally {\n      currentValues[self.slot] = saved;\n    }\n  }\n});\n\n// This is like Meteor.bindEnvironment.\n// Experimentally, we are NOT including onException or _this in this version.\nexports.bindEnvironment = function (func) {\n  exports.nodeCodeMustBeInFiber();\n\n  var boundValues = _.clone(Fiber.current._meteorDynamics || {});\n\n  return function (...args) {\n    var self = this;\n\n    var runWithEnvironment = function () {\n      var savedValues = Fiber.current._meteorDynamics;\n      try {\n        // Need to clone boundValues in case two fibers invoke this\n        // function at the same time\n        Fiber.current._meteorDynamics = _.clone(boundValues);\n        return func.apply(self, args);\n      } finally {\n        Fiber.current._meteorDynamics = savedValues;\n      }\n    };\n\n    if (Fiber.current)\n      return runWithEnvironment();\n    Fiber(runWithEnvironment).run();\n  };\n};\n\n// An alternative to bindEnvironment for the rare case where you\n// want the callback you're passing to some Node function to start\n// a new fiber but *NOT* to inherit the current environment.\n// Eg, if you are trying to do the equivalent of start a background\n// thread.\nexports.inBareFiber = function (func) {\n  return function (...args) {\n    var self = this;\n    new Fiber(function () {\n      func.apply(self, args);\n    }).run();\n  };\n};\n"]}