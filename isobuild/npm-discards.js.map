{"version":3,"sources":["/tools/isobuild/npm-discards.js"],"names":[],"mappings":"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","file":"tools/isobuild/npm-discards.js.map","sourcesContent":["var assert = require(\"assert\");\nvar files = require('../fs/files.js');\nvar _ = require(\"underscore\");\n\n// This class encapsulates a structured specification of files and\n// directories that should be stripped from the node_modules directories\n// of Meteor packages during `meteor build`, as requested by calling\n// `Npm.discard` in package.js files.\nfunction NpmDiscards() {\n  assert.ok(this instanceof NpmDiscards);\n  this.discards = {};\n}\n\nvar NDp = NpmDiscards.prototype;\n\n// Update the current specification of discarded files with additional\n// patterns that should be discarded. See the comment in package-source.js\n// about `Npm.strip` for an explanation of what should be passed for the\n// `discards` parameter.\nNDp.merge = function(discards) {\n  merge(this.discards, discards);\n};\n\nfunction merge(into, from) {\n  _.each(from, function(fromValue, packageName) {\n    var intoValue = _.has(into, packageName) && into[packageName];\n    if (_.isString(fromValue) ||\n        _.isRegExp(fromValue)) {\n      if (intoValue) {\n        intoValue.push(fromValue);\n      } else {\n        into[packageName] = [fromValue];\n      }\n    } else if (_.isArray(fromValue)) {\n      if (intoValue) {\n        intoValue.push.apply(intoValue, fromValue);\n      } else {\n        // Make a defensive copy of any arrays passed to `Npm.strip`.\n        into[packageName] = fromValue.slice(0);\n      }\n    }\n  });\n}\n\nNDp.shouldDiscard = function shouldDiscard(candidatePath, isDirectory) {\n  if (typeof isDirectory === \"undefined\") {\n    isDirectory = files.lstat(candidatePath).isDirectory();\n  }\n\n  for (var currentPath = candidatePath, parentPath;\n       (parentPath = files.pathDirname(currentPath)) !== currentPath;\n       currentPath = parentPath) {\n    if (files.pathBasename(parentPath) === \"node_modules\") {\n      var packageName = files.pathBasename(currentPath);\n\n      if (_.has(this.discards, packageName)) {\n        var relPath = files.pathRelative(currentPath, candidatePath);\n\n        if (isDirectory) {\n          relPath = files.pathJoin(relPath, files.pathSep);\n        }\n\n        return this.discards[packageName].some(function(pattern) {\n          return matches(pattern, relPath);\n        });\n      }\n\n      // Stop at the first ancestor node_modules directory we find.\n      break;\n    }\n  }\n\n  return false;\n};\n\n// TODO Improve this. For example we don't currently support wildcard\n// string patterns (just use a RegExp if you need that flexibility).\nfunction matches(pattern, relPath) {\n  if (_.isRegExp(pattern)) {\n    return relPath.match(pattern);\n  }\n\n  assert.ok(_.isString(pattern));\n\n  if (pattern.charAt(0) === files.pathSep) {\n    return relPath.indexOf(pattern.slice(1)) === 0;\n  }\n\n  return relPath.indexOf(pattern) !== -1;\n}\n\nmodule.exports = NpmDiscards;\n"]}