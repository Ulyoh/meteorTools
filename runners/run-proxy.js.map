{"version":3,"sources":["/tools/runners/run-proxy.js"],"names":[],"mappings":"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","file":"tools/runners/run-proxy.js.map","sourcesContent":["var _ = require('underscore');\nvar Future = require('fibers/future');\nvar runLog = require('./run-log.js');\n\n// options: listenPort, proxyToPort, proxyToHost, onFailure\nvar Proxy = function (options) {\n  var self = this;\n\n  self.listenPort = options.listenPort;\n  self.listenHost = options.listenHost;\n  // note: run-all.js updates proxyToPort directly\n  self.proxyToPort = options.proxyToPort;\n  self.proxyToHost = options.proxyToHost || '127.0.0.1';\n  self.onFailure = options.onFailure || function () {};\n\n  self.mode = \"hold\";\n  self.httpQueue = []; // keys: req, res\n  self.websocketQueue = []; // keys: req, socket, head\n\n  self.proxy = null;\n  self.server = null;\n};\n\n_.extend(Proxy.prototype, {\n  // Start the proxy server, block (yield) until it is ready to go\n  // (actively listening on outer and proxying to inner), and then\n  // return.\n  start: function () {\n    var self = this;\n\n    if (self.server)\n      throw new Error(\"already running?\");\n\n    self.started = false;\n\n    var http = require('http');\n    var net = require('net');\n    var httpProxy = require('http-proxy');\n\n    self.proxy = httpProxy.createProxyServer({\n      // agent is required to handle keep-alive, and http-proxy 1.0 is a little\n      // buggy without it: https://github.com/nodejitsu/node-http-proxy/pull/488\n      agent: new http.Agent({ maxSockets: 100 }),\n      xfwd: true\n    });\n\n    var server = self.server = http.createServer(function (req, res) {\n      // Normal HTTP request\n      self.httpQueue.push({ req: req, res: res });\n      self._tryHandleConnections();\n    });\n\n    self.server.on('upgrade', function (req, socket, head) {\n      // Websocket connection\n      self.websocketQueue.push({ req: req, socket: socket, head: head });\n      self._tryHandleConnections();\n    });\n\n    var fut = new Future;\n    self.server.on('error', function (err) {\n      if (err.code === 'EADDRINUSE') {\n        var port = self.listenPort;\n        runLog.log(\n\"Can't listen on port \" + port + \". Perhaps another Meteor is running?\\n\" +\n\"\\n\" +\n\"Running two copies of Meteor in the same application directory\\n\" +\n\"will not work. If something else is using port \" + port + \", you can\\n\" +\n\"specify an alternative port with --port <port>.\");\n      } else if (self.listenHost &&\n                 (err.code === 'ENOTFOUND' || err.code === 'EADDRNOTAVAIL')) {\n        // This handles the case of \"entered a DNS name that's unknown\"\n        // (ENOTFOUND from getaddrinfo) and \"entered some random IP that we\n        // can't bind to\" (EADDRNOTAVAIL from listen).\n        runLog.log(\n\"Can't listen on host \" + self.listenHost + \" (\" + err.code + \" from \" +\n            err.syscall + \").\");\n\n      } else {\n        runLog.log('' + err);\n      }\n      self.onFailure();\n      // Allow start() to return.\n      fut.isResolved() || fut['return']();\n    });\n\n    // Don't crash if the app doesn't respond. instead return an error\n    // immediately. This shouldn't happen much since we try to not\n    // send requests if the app is down.\n    //\n    // Currently, this error is emitted if the proxy->server connection has an\n    // error (whether in HTTP or websocket proxying).  It is not emitted if the\n    // client->proxy connection has an error, though this may change; see\n    // discussion at https://github.com/nodejitsu/node-http-proxy/pull/488\n    self.proxy.on('error', function (err, req, resOrSocket) {\n      if (resOrSocket instanceof http.ServerResponse) {\n        if (!resOrSocket.headersSent) {\n          // Return a 503, but only if we haven't already written headers (or\n          // we'll get an ugly crash about rendering headers twice).  end()\n          // doesn't crash if called twice so we don't have to conditionalize\n          // that call.\n          resOrSocket.writeHead(503, {\n            'Content-Type': 'text/plain'\n          });\n        }\n        resOrSocket.end('Unexpected error.');\n      } else if (resOrSocket instanceof net.Socket) {\n        resOrSocket.end();\n      }\n    });\n\n    self.server.listen(self.listenPort, self.listenHost || '0.0.0.0', function () {\n      if (self.server) {\n        self.started = true;\n      } else {\n        // stop() got called while we were invoking listen! Close the server (we\n        // still have the var server). The rest of the cleanup shouldn't be\n        // necessary.\n        server.close();\n      }\n      fut.isResolved() || fut['return']();\n    });\n\n    fut.wait();\n  },\n\n  // Idempotent.\n  stop: function () {\n    var self = this;\n\n    if (! self.server)\n      return;\n\n    if (! self.started) {\n      // This probably means that we failed to listen. However, there could be a\n      // race condition and we could be in the middle of starting to listen! In\n      // that case, the listen callback will notice that we nulled out server\n      // here.\n      self.server = null;\n      return;\n    }\n\n    // This stops listening but allows existing connections to\n    // complete gracefully.\n    self.server.close();\n    self.server = null;\n\n    // It doesn't seem to be necessary to do anything special to\n    // destroy an httpProxy proxyserver object.\n    self.proxy = null;\n\n    // Drop any held connections.\n    _.each(self.httpQueue, function (c) {\n      c.res.statusCode = 500;\n      c.res.end();\n    });\n    self.httpQueue = [];\n\n    _.each(self.websocketQueue, function (c) {\n      c.socket.destroy();\n    });\n    self.websocketQueue = [];\n\n    self.mode = \"hold\";\n  },\n\n  _tryHandleConnections: function () {\n    var self = this;\n\n    while (self.httpQueue.length) {\n      if (self.mode !== \"errorpage\" && self.mode !== \"proxy\")\n        break;\n\n      var c = self.httpQueue.shift();\n      if (self.mode === \"errorpage\") {\n        showErrorPage(c.res);\n      } else {\n        self.proxy.web(c.req, c.res, {\n          target: 'http://' + self.proxyToHost + ':' + self.proxyToPort\n        });\n      }\n    }\n\n    while (self.websocketQueue.length) {\n      if (self.mode !== \"proxy\")\n        break;\n\n      var c = self.websocketQueue.shift();\n      self.proxy.ws(c.req, c.socket, c.head, {\n        target: 'http://' + self.proxyToHost + ':' + self.proxyToPort\n      });\n    }\n  },\n\n  // The proxy can be in one of three modes:\n  // - \"hold\": hold connections until the mode changes\n  // - \"proxy\": connections are proxied to the configured port\n  // - \"errorpage\": an error page is served to HTTP connections, and\n  //   websocket connections are held\n  //\n  // The initial mode is \"hold\".\n  setMode: function (mode) {\n    var self = this;\n    self.mode = mode;\n    self._tryHandleConnections();\n  }\n});\n\nfunction showErrorPage(res) {\n  // XXX serve an app that shows the logs nicely and that also\n  // knows how to reload when the server comes back up\n  res.writeHead(200, {'Content-Type': 'text/html'});\n  res.write(`\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>App crashing</title>\n    <style type='text/css'>\n      body { margin: 0; }\n      h3 {\n        margin: 0;\n        font-family: sans-serif;\n        padding: 20px 10px 10px 10px;\n        background: #eee;\n      }\n      pre { margin: 20px; }\n    </style>\n  </head>\n\n  <body>\n    <h3>Your app is crashing. Here's the latest log:</h3>\n\n    <pre>`);\n\n      _.each(runLog.getLog(), function (item) {\n        res.write(escapeEntities(item.message) + \"\\n\");\n      });\n\n      res.write(`</pre>\n  </body>\n</html>`)\n\n  res.end();\n}\n\n// Copied from packages/blaze/preamble.js\nfunction escapeEntities(str) {\n  const escapeMap = {\n    \"<\": \"&lt;\",\n    \">\": \"&gt;\",\n    '\"': \"&quot;\",\n    \"'\": \"&#x27;\",\n    \"`\": \"&#x60;\", /* IE allows backtick-delimited attributes?? */\n    \"&\": \"&amp;\"\n  };\n\n  const escapeChar = function(c) {\n    return escapeMap[c];\n  };\n\n  return str.replace(/[&<>\"'`]/g, escapeChar);\n}\n\nexports.Proxy = Proxy;\n"]}